<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with jLaTeX2HTML 2002-2-1 (1.70) JA patch-2.0
patched version by:  Kenshi Muto, Debian Project.
* modified by:  Shige TAKENO
LaTeX2HTML 2002-2-1 (1.70),
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>NTCP: NAT traversal TCP
HOWTO</TITLE>
<META NAME="description" CONTENT="NTCP: NAT traversal TCP
HOWTO">
<META NAME="keywords" CONTENT="howto">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META NAME="Generator" CONTENT="jLaTeX2HTML v2002-2-1 JA patch-2.0">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="howto.css">

</HEAD>

<BODY >
<!--Navigation Panel-->
<IMG WIDTH="81" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next_inactive"
 SRC="file:/usr/share/latex2html/icons/nx_grp_g.png"> 
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="file:/usr/share/latex2html/icons/up_g.png"> 
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="file:/usr/share/latex2html/icons/prev_g.png">   
<BR>
<BR>
<BR>
<!--End of Navigation Panel-->
<H1 ALIGN="CENTER">NTCP: NAT traversal TCP
<BR>
HOWTO</H1>
<DIV>

<P ALIGN="CENTER"><STRONG>Luca Gaballo</STRONG></P>
</DIV>
<BR>

<H2><A NAME="SECTION00010000000000000000">
Contents</A>
</H2>
<!--Table of Contents-->

<UL>
<LI><A NAME="tex2html34"
  HREF="howto.html#SECTION00020000000000000000">Product name and version number</A>
<LI><A NAME="tex2html35"
  HREF="howto.html#SECTION00030000000000000000">Company name</A>
<LI><A NAME="tex2html36"
  HREF="howto.html#SECTION00040000000000000000">New and special in this release</A>
<LI><A NAME="tex2html37"
  HREF="howto.html#SECTION00050000000000000000">Download source code and documentation</A>
<LI><A NAME="tex2html38"
  HREF="howto.html#SECTION00060000000000000000">Hardware and software requirements</A>
<LI><A NAME="tex2html39"
  HREF="howto.html#SECTION00070000000000000000">Installation instructions, getting started tips, and documentation</A>
<UL>
<LI><A NAME="tex2html40"
  HREF="howto.html#SECTION00071000000000000000">Installation</A>
<LI><A NAME="tex2html41"
  HREF="howto.html#SECTION00072000000000000000">Modules' structure</A>
<LI><A NAME="tex2html42"
  HREF="howto.html#SECTION00073000000000000000">Getting started</A>
<LI><A NAME="tex2html43"
  HREF="howto.html#SECTION00074000000000000000">Start server and connection broker</A>
<LI><A NAME="tex2html44"
  HREF="howto.html#SECTION00075000000000000000">Configuration files</A>
<LI><A NAME="tex2html45"
  HREF="howto.html#SECTION00076000000000000000">API Documentation</A>
</UL>
<BR>
<LI><A NAME="tex2html46"
  HREF="howto.html#SECTION00080000000000000000">Important known problems</A>
<LI><A NAME="tex2html47"
  HREF="howto.html#SECTION00090000000000000000">Version history</A>
<LI><A NAME="tex2html48"
  HREF="howto.html#SECTION000100000000000000000">Contact information</A>
<LI><A NAME="tex2html49"
  HREF="howto.html#SECTION000110000000000000000">Legal information</A>
</UL>
<!--End of Table of Contents-->
<P>

<H1><A NAME="SECTION00020000000000000000">
Product name and version number</A>
</H1>

<P>
Name: NTCP (NAT Traversal TCP)
<BR>
version: 0.1

<P>

<H1><A NAME="SECTION00030000000000000000">
Company name</A>
</H1>

<P>
Company: France Telecom R&amp;D 
<BR>
Department: MAPS/MMC 
<BR>
Project: SOLIPSIS 
<BR><TT><A NAME="tex2html1"
  HREF="http://solipsis.netofpeers.net/wiki2/index.php/Main_Page">http://solipsis.netofpeers.net/wiki2/index.php/Main_Page</A></TT> 
<BR>
<P>

<H1><A NAME="SECTION00040000000000000000">
New and special in this release</A>
</H1>

<P>
It's the first release...everything is new!!! :)

<P>

<H1><A NAME="SECTION00050000000000000000">
Download source code and documentation</A>
</H1>

<P>

<H3><A NAME="SECTION00050100000000000000">
Anonymous SVN Access</A>
</H3>

<P>
The project's BerliOS Developer SVN repository can be checked out through anonymous (svnserver) SVN with the following instruction set. To see the list of the subdirectories available in the repository use the web-based SVN repository access with ViewCVS or WebSVN.
<PRE>
svn checkout svn://svn.berlios.de/ntcp/trunk
</PRE>

<P>

<H3><A NAME="SECTION00050200000000000000">
Developer SVN Access via SSH</A>
</H3>

<P>
Only project developers can access the SVN tree via this method. SSH2 must be installed on your client machine. Substitute developername with the proper value. Enter your site password when prompted.

<P>
<PRE>
svn checkout \
svn+ssh://developername@svn.berlios.de/svnroot/repos/ntcp/trunk
</PRE>

<P>
The subdirectories for documentation or source code only are respectively:

<P>

<UL>
<LI>/ntcp/trunk/doc
</LI>
<LI>/ntcp/trunk/p2pNetwork
</LI>
</UL>

<P>

<H1><A NAME="SECTION00060000000000000000">
Hardware and software requirements</A>
</H1>

<P>

<H2><A NAME="SECTION00061000000000000000">
General Requirements</A>
</H2>

<UL>
<LI><B>Python</B> 
<BR><TT><A NAME="tex2html2"
  HREF="http://www.python.org/">http://www.python.org/</A></TT>
</LI>
<LI><B>Twisted</B> (at least 1.3)
<BR><TT><A NAME="tex2html3"
  HREF="http://twistedmatrix.com/projects/core/">http://twistedmatrix.com/projects/core/</A></TT>
<P>
</LI>
</UL>

<P>

<H2><A NAME="SECTION00062000000000000000">
Special Unix Requirements</A>
</H2>

<UL>
<LI><B>libpcap</B> (at least 0.9.1)
</LI>
<LI><B>Pcapy</B>: python library for spoofing (modification of address, SYN, ACK, TTL, ...) (<TT><A NAME="tex2html4"
  HREF="http://oss.coresecurity.com/projects/pcapy.html">http://oss.coresecurity.com/projects/pcapy.html</A></TT>)
</LI>
<LI><B>Impacket</B>: python library to sniff and listen for outgoing packets 
<BR><TT><A NAME="tex2html5"
  HREF="http://oss.coresecurity.com/projects">http://oss.coresecurity.com/projects</A></TT>
</LI>
</UL>

<P>

<H2><A NAME="SECTION00063000000000000000">
Special Windows Requirements</A>
</H2>

<UL>
<LI><B>Python</B> (at least 2.3): 
	some socket options are not available in the previous version	
</LI>
<LI><B>winpcap</B> (at least 3.0): the packet capture library for Windows 
<BR><TT><A NAME="tex2html6"
  HREF="http://www.winpcap.org">http://www.winpcap.org</A></TT>
</LI>
<LI><B>Netwox</B>: library in C language for spoofing 
<BR><TT><A NAME="tex2html7"
  HREF="http://www.laurentconstantin.com/en/netw/">http://www.laurentconstantin.com/en/netw/</A></TT>
</LI>
<LI><B>Impacket</B>: python library to sniff and listen for outgoing packets 
<BR><TT><A NAME="tex2html8"
  HREF="http://oss.coresecurity.com/projects">http://oss.coresecurity.com/projects</A></TT>
<P>
</LI>
</UL>

<P>

<H1><A NAME="SECTION00070000000000000000">
Installation instructions, getting started tips, and documentation</A>
</H1>

<P>

<H2><A NAME="SECTION00071000000000000000">
Installation</A>
</H2>

<P>
There is no installation procedure at now. So download the source code (see download section),
put it to the desired folder, and make the PYTHONPATH environment variable to point it. 
Execute this command or put it in your '<I>profile</I>' file.

<P>
<PRE>
export PYTHONPATH=\$PYTHONPATH:/directory_to_ntcp/ntcp/trunk
</PRE>

<P>

<H2><A NAME="SECTION00072000000000000000">
Modules' structure</A>
</H2>
The source code in the /ntct/trunk/p2pNetwork is organized like exposend 

<P>
<PRE>
/ntcp/trunk/p2pNetwork

 |
 |__ discover: to discover NAT presence and configuration (use STUN)
 |
 |__ htcp: Connection Broker and Hole Punching code
 |
 |__ stun: STUN code (client and server)
 |
 |__ testTCP: tests for TCP through NAT connectivity
 |
 |__ solipsisSimulator.py: an application example
</PRE>
<H2><A NAME="SECTION00073000000000000000">
Getting started</A>
</H2>

<P>
To know how to use <I>ntcp</I> library in your code look at the examples.
There are two sections, one for UDP and the other for TCP connectivity. 

<P>
The UDP connectivity module is complete and allow to make communication
between two endhost behind two different NATs. It needs of a STUN server and 
a Connection Broker in the public network.

<P>
The TCP connectivity module is still in the test phase. You test a TCP
communication with or without spoofing. This module will remplace the UDP 
module integrating him. 

<P>

<H3><A NAME="SECTION00073100000000000000">
UDP connectivity</A>
</H3>
Here the most important code sections, you can find the complete code 
of <I>solipsisSimulator.py</I> in the source code (See Download section).

<P>
In the code listing <A HREF="#import">1</A> we import all the needed library for:

<UL>
<LI>stun: for STUN procedure to discover the NAT presence
and its configuration. 
</LI>
<LI>punch: for hole punching through the Connection Broker
</LI>
<LI>defer: to recovery the signal of all asynchronous procedure
</LI>
</UL>

<P>
commentstyle=
<BR>
<IMG
 WIDTH="567" HEIGHT="86" ALIGN="BOTTOM" BORDER="0"
 SRC="img1.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Import packets},label=import]{}
import p2...
...rk.htcp.puncher as punch
import twisted.internet.defer as defer
\end{lstlisting}">
<BR>

<P>
In the listing <A HREF="#discover">2</A> we start the procedure for the NAT discovery.
This function look at NAT presence and try to find information about it.
We set the procedure for the comebacking signal too.

<P>
<BR>
<IMG
 WIDTH="567" HEIGHT="162" ALIGN="BOTTOM" BORDER="0"
 SRC="img2.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Start discover code},label=discover]{}
de...
...unPort, reactor)
d.addCallback(succeed)
d.addErrback(fail)
\par
\end{lstlisting}">
<BR>

<P>
If the discovery procedure fail, because there is a firewall or for a network
problem, the function <I>fail</I>, showed in listing <A HREF="#fail">3</A> is called.

<P>
<BR>
<IMG
 WIDTH="567" HEIGHT="86" ALIGN="BOTTOM" BORDER="0"
 SRC="img3.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Failure callback function code},label=fai...
...l(failure):
'''''' Fail in STUN discover ''''''
print failure
\end{lstlisting}">
<BR>

<P>
If the discovery procedure succeeded the function showed in listing <A HREF="#succeed">4</A> 
is called. Now we know if there is a NAT and what type of NAT, so the 
eventually registration at the Connection Broker (CB) can be called.
To register at the CB you have to call the <I>punch.HolePunching(port, reactor, netconf, id)</I>
function. For details see the API documentation.
<BR>
<IMG
 WIDTH="567" HEIGHT="430" ALIGN="BOTTOM" BORDER="0"
 SRC="img4.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Succeeded callback function code},label=s...
..., id)
d.addCallback(registrationMade)
d.addErrback(fail)
\par
\end{lstlisting}">
<BR>

<P>
Finally, after the registration at the CB, you can start to communicate, in UDP,
with another endpoint. Call the <I>puncher.connectByURI(peerURI)</I> function
and pass it the id of the other endpoint you want to connect to.
<BR>

<BR>

<P>

<H3><A NAME="SECTION00073200000000000000">
TCP connectivity</A>
</H3>
You can find the complete code of the examples of this section in 
<I>testTCPcl.py</I> source code file (See Download section).

<P>
TCP connectivity module is still in the test phase. You can test a TCP
communication with or without spoofing. This module will remplace the UDP 
module integrating him. The compatibility with previous version is not assured.

<P>
The listing code <A HREF="#importTCP">6</A> shows the needed packet imported for your TCP 
connection. There are two modules, one to allow sniffing packets and one to allow
UDP communication with the CB or the other endpoint.

<P>
commentstyle=
<BR>
<IMG
 WIDTH="567" HEIGHT="86" ALIGN="BOTTOM" BORDER="0"
 SRC="img6.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Import packets},label=importTCP]{}
import...
... as sniffer
import p2pNetwork.testTCP.udpSniffer as udp_sniffer
\end{lstlisting}">
<BR>

<P>
Before start TCP connection you have to load the configuration 
preset in the <I>test.conf</I> file. See the Set Configuration section.
commentstyle=
<BR>
<IMG
 WIDTH="567" HEIGHT="181" ALIGN="BOTTOM" BORDER="0"
 SRC="img7.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Load configuration},label=config]{}
...">
<BR>

<P>
Finally the <I>connect()</I>. Don't forget to establish an UDP communication
with the CB or with the other endpoint and start sniffing in a thread using 
<I>udp_sniffer.UDP_factory()</I> and <I>sniffer.sniff(argv, udp_obj)</I> functions.

<P>
commentstyle=
<BR>

<BR>

<P>
To choose the connection method (with or without spoofing), you have to set
the variable <I>withSpoofing</I> (1 for spoofing, 0 otherwise), in <I>testTCP/udpSniffer.py</I>
file. If you use the spoofing method you have to set the ConnectionBroker address in the configuration file
like explained in the Configuration files section.

<P>
commentstyle=
<BR>
<IMG
 WIDTH="567" HEIGHT="181" ALIGN="BOTTOM" BORDER="0"
 SRC="img9.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={Choose the connection method},label=threa...
...
\par
def __init__(self):
...
self.withSpoofing = 0
...
\par
\end{lstlisting}">
<BR>

<P>

<H2><A NAME="SECTION00074000000000000000">
Start server and connection broker</A>
</H2>

<P>
For particular settings see the Configuration files section.

<P>

<UL>
<LI>STUN server: start the python file <I>p2pNetwork/stun/server.py</I>
</LI>
<LI>UDP Connection Broker: start the python file <I>p2pNetwork/htcp/connectionBroker.py</I>
</LI>
<LI>TCP Connection Broker: start the python file <I>p2pNetwork/testTCP/natTravCB.py</I>

<P>
</LI>
</UL>

<P>

<H2><A NAME="SECTION00075000000000000000">
Configuration files</A>
</H2>
Before to start use the ntcp library, you have to configure 
the configuration files for the different two modules.

<P>

<UL>
<LI>UDP module: <I>p2pNetwork.conf</I>
commentstyle=
<BR>
<IMG
 WIDTH="567" HEIGHT="277" ALIGN="BOTTOM" BORDER="0"
 SRC="img10.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={p2pNetwork.conf},label=p2pNetwork]{}
[stu...
...configuration
[holePunch]
ConnectionBroker: 10.193.163.246:6060
\end{lstlisting}">
<BR>

<P>
</LI>
<LI>TCP module: <I>test.conf</I>
commentstyle=
<BR>
<IMG
 WIDTH="567" HEIGHT="372" ALIGN="BOTTOM" BORDER="0"
 SRC="img11.png"
 ALT="\begin{lstlisting}[frame=trbl,caption={test.conf},label=test]{}
[CB]
...">
<BR>
</LI>
</UL>

<P>

<H2><A NAME="SECTION00076000000000000000">
API Documentation</A>
</H2>
For the complete API documentation see the python documentation
in /ntcp/trunk/doc/apidoc/ directory

<P>

<H1><A NAME="SECTION00080000000000000000">
Important known problems</A>
</H1>

<P>
The <I>ntcp</I> is still in an initial phase, it isn't stable
and dynamically configurable. 

<P>

<H1><A NAME="SECTION00090000000000000000">
Version history</A>
</H1>

<P>
Release 0.1: First release of NTCP

<UL>
<LI>STUN implementation (client and server) 
</LI>
<LI>UDP Hole punching (Puncher and Connection Broker)
</LI>
<LI>test for TCP NAT traversal 

<P>
</LI>
</UL>

<P>

<H1><A NAME="SECTION000100000000000000000">
Contact information</A>
</H1>

<P>
Gaballo Luca 
<BR>
mail: gaballo.luca@rd.francetelecom.com 
<BR>
Tel: 01 45 29 63 03 
<BR>
<P>

<H1><A NAME="SECTION000110000000000000000">
Legal information</A>
</H1>
...

<P>

<H1><A NAME="SECTION000120000000000000000">
About this document ...</A>
</H1>
 <STRONG>NTCP: NAT traversal TCP
<BR>
HOWTO</STRONG><P>
This document was generated using the
<A HREF="http://www.latex2html.org/"><STRONG>LaTeX</STRONG>2<tt>HTML</tt></A> translator Version 2002-2-1 (1.70)
<P>
Copyright &#169; 1993, 1994, 1995, 1996,
<A HREF="http://cbl.leeds.ac.uk/nikos/personal.html">Nikos Drakos</A>, 
Computer Based Learning Unit, University of Leeds.
<BR>
Copyright &#169; 1997, 1998, 1999,
<A HREF="http://www.maths.mq.edu.au/~ross/">Ross Moore</A>, 
Mathematics Department, Macquarie University, Sydney.
<P>
The command line arguments were: <BR>
 <STRONG>latex2html</STRONG> <TT>howto.tex -split 3</TT>
<P>
The translation was initiated by Gaballo Luca on 2005-07-11
<BR><HR>
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"></A>

<UL>
<LI><A NAME="tex2html9"
  HREF="howto.html#SECTION00010000000000000000">Contents</A>
<LI><A NAME="tex2html10"
  HREF="howto.html#SECTION00020000000000000000">Product name and version number</A>
<LI><A NAME="tex2html11"
  HREF="howto.html#SECTION00030000000000000000">Company name</A>
<LI><A NAME="tex2html12"
  HREF="howto.html#SECTION00040000000000000000">New and special in this release</A>
<LI><A NAME="tex2html13"
  HREF="howto.html#SECTION00050000000000000000">Download source code and documentation</A>
<UL>
<LI><A NAME="tex2html14"
  HREF="howto.html#SECTION00050100000000000000">Anonymous SVN Access</A>
<LI><A NAME="tex2html15"
  HREF="howto.html#SECTION00050200000000000000">Developer SVN Access via SSH</A>
</UL>
<BR>
<LI><A NAME="tex2html16"
  HREF="howto.html#SECTION00060000000000000000">Hardware and software requirements</A>
<UL>
<LI><A NAME="tex2html17"
  HREF="howto.html#SECTION00061000000000000000">General Requirements</A>
<LI><A NAME="tex2html18"
  HREF="howto.html#SECTION00062000000000000000">Special Unix Requirements</A>
<LI><A NAME="tex2html19"
  HREF="howto.html#SECTION00063000000000000000">Special Windows Requirements</A>
</UL>
<BR>
<LI><A NAME="tex2html20"
  HREF="howto.html#SECTION00070000000000000000">Installation instructions, getting started tips, and documentation</A>
<UL>
<LI><A NAME="tex2html21"
  HREF="howto.html#SECTION00071000000000000000">Installation</A>
<LI><A NAME="tex2html22"
  HREF="howto.html#SECTION00072000000000000000">Modules' structure</A>
<LI><A NAME="tex2html23"
  HREF="howto.html#SECTION00073000000000000000">Getting started</A>
<UL>
<LI><A NAME="tex2html24"
  HREF="howto.html#SECTION00073100000000000000">UDP connectivity</A>
<LI><A NAME="tex2html25"
  HREF="howto.html#SECTION00073200000000000000">TCP connectivity</A>
</UL>
<LI><A NAME="tex2html26"
  HREF="howto.html#SECTION00074000000000000000">Start server and connection broker</A>
<LI><A NAME="tex2html27"
  HREF="howto.html#SECTION00075000000000000000">Configuration files</A>
<LI><A NAME="tex2html28"
  HREF="howto.html#SECTION00076000000000000000">API Documentation</A>
</UL>
<BR>
<LI><A NAME="tex2html29"
  HREF="howto.html#SECTION00080000000000000000">Important known problems</A>
<LI><A NAME="tex2html30"
  HREF="howto.html#SECTION00090000000000000000">Version history</A>
<LI><A NAME="tex2html31"
  HREF="howto.html#SECTION000100000000000000000">Contact information</A>
<LI><A NAME="tex2html32"
  HREF="howto.html#SECTION000110000000000000000">Legal information</A>
<LI><A NAME="tex2html33"
  HREF="howto.html#SECTION000120000000000000000">About this document ...</A>
</UL>
<!--End of Table of Child-Links-->
<HR>
<!--Navigation Panel-->
<IMG WIDTH="81" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next_inactive"
 SRC="file:/usr/share/latex2html/icons/nx_grp_g.png"> 
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="file:/usr/share/latex2html/icons/up_g.png"> 
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="file:/usr/share/latex2html/icons/prev_g.png">   
<BR>
<!--End of Navigation Panel-->
<ADDRESS>
Gaballo Luca
2005-07-11
</ADDRESS>
</BODY>
</HTML>
